<!DOCTYPE html>
<html>
  <head>
    <title>Tests for Hyper_JS</title>
    <style>
      body { background: #F0F0F0; padding-bottom: 50px; }
      #results div { padding: 10px ; margin-right: 5px; margin-bottom: 5px; }
      #results span { font-size: 90%; font-family: monospace; font-weight: bold; }
      div.passed { background: #CFDB00; float: left; }
      div.failed { background: #DB0013; float: left; }
    </style>
  </head>
  <body>
  <div id="stage">
    <ul id="list">
      <li>{name}</li>
    </ul>
    <ul id="list_2nd">
      <li>{name}</li>
    </ul>
  </div>
  <div id="results" onclick="window.location.reload();">
  </div>
    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="http://underscorejs.org/underscore-min.js"></script>
    <script src="http://backbonejs.org/backbone-min.js"></script>
    <script src="./Hyper_JS.js" type="text/javascript"></script>
    <script>

var test_name = null;
function test (name, func) {
  test_name = name;
  try {
    func();
  } catch (e) {
    error(name, e);
  }
}

function span(txt) {
  return '<span>' + (txt + '').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</span>';
}
function passed(name, exp, act) {
  $('#results').append('<div class="passed">' + span(exp) + ' === ' + span(act) + '<br /> ' + name + '</div>');
}

function failed(name, exp, act) {
  $('#results').append('<div class="failed">' + span(exp) + ' === ' + span(act) + '<br /> ' + name + '</div>');
}

function error(name, act) {
  $('#results').append('<div class="failed">' + span(act) + '<br /> ' + name + '</div>');
}

function assert (exp, act, name) {
  if (exp === act)
    passed(name || test_name, exp, act);
  else
    failed(name || test_name, exp, act)

}

window.onerror = function (msg, file, line) {
  error(msg, file + ':' + line);
}

var template = function (o) {
  return "<li>" + o.obj.name + "</li>";
};

var list = Hyper_JS.new("#list", template, []);

test(".new: emptys element containing models", function () {
  assert(0, $('#list').children().length);
});

test(".new: saves html to .template", function () {
  assert('<li>{name}</li>', $.trim(list.template));
});

test("append: runs .trigger('no-empty') if list was previously empty", function () {
  var events = [];
  list.on('no-empty', function () { events.push('no longer empty'); });
  list.append({name: "Konrad Zuze", job: "genius"});
  assert("no longer empty", events[0]);
});

test("append: adds element to bottom", function () {
  list.append({name: "Ted Nelson", job: "genius"});
  assert("Ted Nelson", $('#list li').last().text());

  list.append({name: "Michael Faraday", job: "genius"});
  assert("Michael Faraday", $('#list li').last().text());
});

test("append: runs .trigger('update')", function () {
  var events = [];
  list.on('update', function () {
    events.push('new push');
  });
  list.append({name: "David Talbott", job: "genius"});
  list.off('update');
  assert("new push", events[0]);
});

test("prepend: adds element to top", function () {
  list.prepend({name: "Alan Kay", job: "genius"});
  assert("Alan Kay", $('#list li').first().text());

  list.prepend({name: "Engelbart", job: "genius"});
  assert("Engelbart", $('#list li').first().text());
});

test("prepend: runs .trigger('update')", function () {
  var events = [];
  list.on('update', function () {
    events.push('new unshift');
  });

  list.prepend({name: "Wal Thornhill", job: "genius"});
  list.off('update');


  assert("new unshift", events[0]);
});


test("pop: runs .trigger('empty') if last element is pop-ed", function () {
  $('#list_2nd').empty();
  var events = [];
  var list = Hyper_JS.new('#list_2nd', function () { return '<li>text</li>'; }, []);
  list.append({name: "Wally", job: 'lay about'});
  list.on('empty', function () { events.push('now empty'); });
  list.pop();
  assert('now empty', events[0]);
});

test('pop: removes element at bottom', function () {
  var text = $('#list li').last().text();
  list.append({name: "1", job: "genius"});
  list.pop();
  assert(text, $('#list li').last().text());
});

test("shift: runs .trigger('empty') if last element is shift-ed", function () {
  $('#list_2nd').empty();
  var events = [];
  var list = Hyper_JS.new('#list_2nd', function () { return '<li>text</li>'; }, []);
  list.append({name: "Wally", job: 'lay about'});
  list.on('empty', function () { events.push('now empty'); });
  list.shift();
  assert('now empty', events[0]);
});

test('shift: removes element at top', function () {
  var text = $('#list li').first().text();
  var next = $($('#list li')[1]).text();
  list.shift();
  assert(next, $('#list li').first().text());
});


test("Hyper_JS.on('new'): runs on .new call", function () {
  var events = [];
  Hyper_JS.on('new', function (o) { events.push('created'); });
  Hyper_JS.new('#list_2nd', function () {}, []);
  assert("created", events[0]);
})

    </script>
<!-- setTimeout(function () { window.location.reload(); }, 1000); -->
  </body>
</html>

